<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>首页</title>
    <link rel="stylesheet" href="/static/css/home.css">
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/bootstrap-3.4.1-dist/css/bootstrap.css">

</head>
<body>
{% csrf_token %}
<div class="home-p">
    <div class="logout">
        <button id="logout-but">退出登录</button>
    </div>
    <div class="title">
        <div class="titles">
            <!-- 通常可以用ul，语义化，而不是都用div -->
            <div class="setting">
                <div class="setting-content">
                    <span id="setting-text">项目配置</span>
                </div>
                <div class="setting-line"></div>
            </div>
            <div class="project">
                <span id="project-text">模块</span>
                <div class="project-line"></div>
            </div>
            <div class="case-list">
                <span id="case-text">用例</span>
            </div>
            <div class="test-suite">
                <span id="suite-text">测试集</span>
            </div>
            <div class="test-plan">
                <span id="plan-text">测试计划</span>
            </div>
            <div class="test-report">
                <span id="report-text">测试报告</span>
            </div>
        </div>
    </div>
</div>
<!-- 项目配置列表/表格 -->
<div class="add-env-but">
    <button class="add-button">
        <span id="add-env-button">
            新增环境
        </span>
    </button>
</div>
<!-- 新增弹窗 -->
<div class="add-env">
    <div class="add-env-win">
        <div class="new-env">
            <div class="add-env-close">
                <button id="close-but">
                    <span>x</span>
                </button>
            </div>
            <div class="add-env-content">
                <p>环境名：<input type="text" id="env-name"></p>
                <p>Host：<input type="text" id="env-host"></p>
                <p>描述：<input type="text" id="env-description"></p>
            </div>
            <div class="add-new-but">
                <div class="env-save-but">
                    <button>保存</button>
                </div>
                <div class="env-cancel-but">
                    <button id="env-cancel">取消</button>
                </div>
            </div>
        </div>
    </div>

</div>
<table class="set-contents" border="1">
    <thead>
    <tr id="env-list-fist">
        <th>&nbsp  ID  &nbsp</th>
        <th>环境名</th>
        <th>URL</th>
        <th>环境描述</th>
        <th>创建时间</th>
        <th>更新时间</th>
        <th>操作</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>
<!-- 模块列表/表格 -->

<!-- 测试用例列表/表格 -->

<!-- 测试集列表/表格 -->

<!-- 测试计划列表/表格 -->

<!-- 报告模块列表/表格 -->


<script src="/static/js/jquery/jquery-3.6.0.min.js"></script>
<script>
    <!-- 访问home页面,默认查询env数据返回-->
    reqEnv();
    //项目配置被选中效果
    <!-- 公用函数 -->

    <!-- 新增册数环境 -->
    var ne = document.querySelector(".add-env");
    document.getElementsByClassName("add-button")[0].onclick = function(){addEnv()};
    function addEnv(){
        ne.style.display = 'block';
    }
    <!-- 取消和关闭新增的输入弹框 -->
     function find(yuan) {
         document.querySelector(yuan).onclick= function () {
             ne.style.display = 'none';
         }
     }
    find("#close-but");
    find("#env-cancel");
     /*
    document.querySelector("#close-but").onclick = function(){
        ne.style.display='none';
    }
    document.querySelector("#env-cancel").onclick = function(){
        ne.style.display='none';
    }
    */
    <!-- 保存,同时向后台发送请求保存数据 关闭弹框 -->
    var token = document.getElementsByName("csrfmiddlewaretoken")[0].value;
    document.querySelector(".env-save-but").onclick = function(){
        let name = document.querySelector("#env-name");
        let host = document.querySelector("#env-host");
        let dec = document.querySelector("#env-description");
        let pas = JSON.stringify({"name":name.value, "host_url": host.value, "env_description": dec.value});
        let xttp = new XMLHttpRequest();
        xttp.open("POST","./autotest/env_add/",true);
        xttp.setRequestHeader("X-CSRFToken",token);
        xttp.setRequestHeader("X-Requested-With","XMLHttpRequest");
        xttp.send(pas)
        xttp.onreadystatechange =function () {
            if (this.readyState==4 && this.status == 200){
                console.log("新增成功")
                name.value='';
                host.value='';
                dec.value='';
                ne.style.display = 'none';
                reqEnv();
            }
            else{
                ne.style.display = 'none';
            }
        }
    }
    <!-- 点击查询项目配置 -->
    var temp = `
    <tr class="env-list-data">
        <td name="list-env-id">{id}</td>
        <td name="list-env-name">{name}</td>
        <td name=" list-host">{host_url}</td>
        <td name="list-dec">{env_description}</td>
        <td name="list-ctime">{create_time}</td>
        <td name="list-uptime">{update_time}</td>
        <td class="list-op">
            <button class="env-edit">编辑</button>
            <button class="env-delete">删除</button></td>
        </tr>`
    <!-- 如果要放在标签的写法 -->
    //var temp= document.querySelector('tbody').innerHTML
    {#console.log(temp)#}
    document.querySelector(".setting").onclick = function(){
        reqEnv();
    }

    <!-- 请求环境配置查询的函数-->
    function reqEnv(){
        let envttp = new XMLHttpRequest();
        //每当 readyState 发生变化时就会调用 onreadystatechange 函数,所以判断条件需要this.readyState==4
        envttp.onreadystatechange=function () {
            if (this.readyState==4 && this.status==200){
                //console.log(envttp.responseText)
                var innerHTML= '';
                data = JSON.parse(envttp.responseText);
                envdata = data["data"];
                for (let envs in envdata){
                    //console.log(envs,typeof envs);
                    ds = envdata[parseInt(envs)];
                    var t = temp; //这里的赋值要保证每次循环数据的时候，t都是空的
                        for (d in ds){
                            t = t.split('{' + d + '}').join(ds[d]);
                        }
                    innerHTML += t;
                    }
                }
                document.querySelector('tbody').innerHTML = innerHTML;
            };
        envttp.open("GET", "./autotest/env/", true);
        envttp.setRequestHeader("X-CSRFToken",token);
        envttp.setRequestHeader("X-Requested-With","XMLHttpRequest");
        envttp.send();
    }
    <!-- 编辑环境 -->

    <!-- 删除环境-->
    var t =document.querySelector(".set-contents")
    t.addEventListener("click",(event)=>{
        if ( !event.target.classList.contains("env-delete") ){
            return;
        }
        var deenv = event.target.parentNode.parentNode
        var na = deenv.querySelector("[name='list-env-name']").innerText;
        envDel(na);
    })

    function envDel(name){
        fetch("./autotest/env_delete/",{
            method:"DELETE",
            headers:{"X-CSRFToken":token,"X-Requested-With":"XMLHttpRequest"},
            body:JSON.stringify({name: name}),
        })
        .then(response => response.json())
        .then(data => {
          console.log('Success:', data);
          reqEnv();
        })
        .catch((error) => {
          console.error('Error:', error);
        });
    }
</script>
</body>
</html>